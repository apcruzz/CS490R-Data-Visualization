<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2024 Overseas Visitors by State</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header>
    <h1>2024 Overseas Visitors by State</h1>
    <p>Leaflet choropleth using NTTO state visitation totals (2024, thousands of visitors)</p>
  </header>

  <div class="map-wrap">
    <div id="map"></div>

    <div class="inset">
      <div id="map-ak" class="inset-map" title="Alaska"></div>
      <div id="map-hi" class="inset-map" title="Hawaii"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="state-visit-data.js"></script>

  <script>
    const STATE_DATA = window.STATE_VISIT_DATA || {};
    const VALUE_FIELD = "visitation2024k"; // values are in thousands (000)
    const colorBreaks = [50, 100, 250, 500, 1000, 2000, 4000, 8000];

    function cssVar(name) {
      const css = getComputedStyle(document.documentElement);
      return css.getPropertyValue(name).trim();
    }

    function getStateName(feature) {
      return feature?.properties?.name || feature?.id || "State";
    }

    function getStateMetric(feature) {
      return STATE_DATA[getStateName(feature)] || null;
    }

    function getFillColor(metric) {
      if (!metric || typeof metric[VALUE_FIELD] !== "number") return cssVar("--no-data");
      const v = metric[VALUE_FIELD];
      if (v > colorBreaks[7]) return "#6e1711";
      if (v > colorBreaks[6]) return "#9b2219";
      if (v > colorBreaks[5]) return "#c33a1f";
      if (v > colorBreaks[4]) return "#e05a2a";
      if (v > colorBreaks[3]) return "#ef8354";
      if (v > colorBreaks[2]) return "#f4a261";
      if (v > colorBreaks[1]) return "#f8bf85";
      if (v > colorBreaks[0]) return "#fbd7ac";
      return "#fee9cf";
    }

    function baseStyle(feature){
      const metric = getStateMetric(feature);
      return {
        color: cssVar("--stroke"),
        weight: 1,
        fillColor: getFillColor(metric),
        fillOpacity: 0.95
      };
    }

    function hoverStyle(){
      return {
        color: "#ffffff",
        weight: 2,
        fillColor: cssVar("--hover"),
        fillOpacity: 1
      };
    }

    function formatThousands(value) {
      return typeof value === "number" ? `${value.toLocaleString()}k` : "No data";
    }

    function formatPercent(value) {
      return typeof value === "number" ? `${(value * 100).toFixed(1)}%` : "No data";
    }

    function attachInteractions(feature, layer){
      const name = getStateName(feature);
      const metric = getStateMetric(feature);
      const tooltipHtml = `
        <div class="tooltip-title">${name}</div>
        <div>${metric ? `Rank: ${metric.rank}` : "Rank: No data"}</div>
        <div>2024 visitation: ${formatThousands(metric?.visitation2024k)}</div>
        <div>2023 visitation: ${formatThousands(metric?.visitation2023k)}</div>
        <div>YoY change: ${formatPercent(metric?.pctChange)}</div>
        <div>2024 market share: ${formatPercent(metric?.marketShare2024)}</div>
      `;

      layer.bindTooltip(tooltipHtml, {
        sticky: true,
        direction: "auto",
        className: "state-tooltip"
      });

      layer.on("mouseover", () => layer.setStyle(hoverStyle()));
      layer.on("mouseout", () => layer.setStyle(baseStyle(feature)));
    }

    function addLegend(map) {
      const legend = L.control({ position: "bottomleft" });
      legend.onAdd = function() {
        const div = L.DomUtil.create("div", "map-legend");
        const labels = [];
        let from = 0;

        for (const to of colorBreaks) {
          labels.push(
            `<div class="legend-row"><span class="swatch" style="background:${getFillColor({ [VALUE_FIELD]: to - 1 })}"></span>${from.toLocaleString()}-${to.toLocaleString()}k</div>`
          );
          from = to;
        }
        labels.push(
          `<div class="legend-row"><span class="swatch" style="background:${getFillColor({ [VALUE_FIELD]: colorBreaks[colorBreaks.length - 1] + 1 })}"></span>${colorBreaks[colorBreaks.length - 1].toLocaleString()}k+</div>`
        );
        labels.push(
          `<div class="legend-row"><span class="swatch" style="background:${cssVar("--no-data")}"></span>No data</div>`
        );

        div.innerHTML = `
          <div class="legend-title">2024 visitation (000)</div>
          ${labels.join("")}
          <div class="legend-note">Source: NTTO / SIAT (workbook provided)</div>
        `;
        return div;
      };
      legend.addTo(map);
    }

    function addSummaryPill(map, geojson) {
      const total = geojson.features.reduce((sum, f) => {
        const v = getStateMetric(f)?.[VALUE_FIELD];
        return sum + (typeof v === "number" ? v : 0);
      }, 0);
      const count = geojson.features.filter(f => typeof getStateMetric(f)?.[VALUE_FIELD] === "number").length;
      const pill = L.control({ position: "topright" });
      pill.onAdd = function() {
        const div = L.DomUtil.create("div", "map-pill");
        div.innerHTML = `<strong>${count}</strong> map regions with data â€¢ <strong>${total.toLocaleString()}k</strong> total visitors`;
        return div;
      };
      pill.addTo(map);
    }

    // ---- Create 3 maps: main + 2 insets ----
    const mainMap = L.map("map", {
      zoomControl: false,
      attributionControl: false,
      preferCanvas: true,
      dragging: true,
      scrollWheelZoom: true
    });

    const akMap = L.map("map-ak", {
      zoomControl: false,
      attributionControl: false,
      preferCanvas: true,
      dragging: false,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false,
      keyboard: false,
      tap: false
    });

    const hiMap = L.map("map-hi", {
      zoomControl: false,
      attributionControl: false,
      preferCanvas: true,
      dragging: false,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false,
      keyboard: false,
      tap: false
    });

    // Optional: stop clicks on inset from panning main map (extra safe)
    L.DomEvent.disableClickPropagation(document.getElementById("map-ak"));
    L.DomEvent.disableClickPropagation(document.getElementById("map-hi"));

    // ---- Load GeoJSON once, split into layers ----
    fetch("us-states.json") // <-- your file name
      .then(r => r.json())
      .then(data => {

        const isAK = f => (f?.properties?.name === "Alaska" || f?.id === "02");
        const isHI = f => (f?.properties?.name === "Hawaii" || f?.id === "15");
        // Lower 48 = everything except Alaska & Hawaii (keep DC if you want)
        const lower48 = {
          type: "FeatureCollection",
          features: data.features.filter(f => !isAK(f) && !isHI(f))
        };

        const alaska = {
          type: "FeatureCollection",
          features: data.features.filter(isAK)
        };

        const hawaii = {
          type: "FeatureCollection",
          features: data.features.filter(isHI)
        };

        // --- Main layer (lower 48) ---
        const lowerLayer = L.geoJSON(lower48, {
          style: baseStyle,
          onEachFeature: attachInteractions
        }).addTo(mainMap);

        mainMap.fitBounds(lowerLayer.getBounds(), { padding: [20, 20] });
        addLegend(mainMap);
        addSummaryPill(mainMap, data);

        // --- Alaska inset ---
        const akLayer = L.geoJSON(alaska, {
          style: baseStyle,
          onEachFeature: attachInteractions
        }).addTo(akMap);

        if (akLayer.getBounds().isValid()) {
          akMap.fitBounds(akLayer.getBounds(), { padding: [10, 10] });
        }

        // --- Hawaii inset ---
        const hiLayer = L.geoJSON(hawaii, {
          style: baseStyle,
          onEachFeature: attachInteractions
        }).addTo(hiMap);

        if (hiLayer.getBounds().isValid()) {
          hiMap.fitBounds(hiLayer.getBounds(), { padding: [10, 10] });
        }

        // ---- "Zoom it in" a bit like D3's framing ----
        // After fitting, zoom in one level for a tighter look:
        mainMap.setZoom(mainMap.getZoom() + 1);

      })
      .catch(err => console.error("Failed to load us-states.json:", err));
  </script>
</body>
</html>
