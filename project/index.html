<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2024 Overseas Visitors by State</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header>
    <div class="header-copy">
      <h1>2024 Overseas Visitors by State</h1>
      <p>Leaflet choropleth using NTTO state visitation totals (2024, thousands of visitors)</p>
    </div>
    <nav class="view-tabs" aria-label="Visualization views">
      <button type="button" class="view-tab is-active" data-tab-target="tab-map">Map</button>
      <button type="button" class="view-tab" data-tab-target="tab-charts">Charts</button>
    </nav>
  </header>

  <section id="tab-map" class="tab-panel is-active">
    <div class="map-wrap">
      <div id="map"></div>

      <div class="inset">
        <div id="map-ak" class="inset-map" title="Alaska"></div>
        <div id="map-hi" class="inset-map" title="Hawaii"></div>
      </div>
    </div>

    <button id="quiz-open-btn" class="quiz-fab" type="button" aria-expanded="false" aria-controls="quiz-panel">
      State Match Quiz
    </button>

    <div class="avatar-controls" aria-label="Avatar controls">
      <button id="avatar-toggle-btn" class="avatar-btn" type="button">Hide Avatars</button>
      <button id="avatar-clear-btn" class="avatar-btn danger" type="button">Clear Avatars</button>
    </div>

    <section id="quiz-panel" class="quiz-panel" aria-label="State recommendation quiz">
      <div class="quiz-panel-header">
        <h2>Find Your State Match</h2>
        <button id="quiz-close-btn" type="button" class="quiz-close-btn" aria-label="Close quiz">X</button>
      </div>
      <div id="quiz-body" class="quiz-body"></div>
      <div class="quiz-controls">
        <button id="quiz-back-btn" type="button" class="quiz-nav-btn">Back</button>
        <button id="quiz-next-btn" type="button" class="quiz-nav-btn primary">Next</button>
      </div>
    </section>
  </section>

  <section id="tab-charts" class="tab-panel">
    <div class="charts-wrap">
      <div class="chart-card chart-wide">
        <h3>Top States by 2024 Visitation</h3>
        <canvas id="bar-chart"></canvas>
      </div>
      <div class="chart-card">
        <h3>2024 Share (Top States + Other)</h3>
        <canvas id="pie-chart"></canvas>
      </div>
      <div class="chart-card chart-wide">
        <h3>2023 vs 2024 by State</h3>
        <canvas id="line-chart"></canvas>
      </div>
    </div>
  </section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="state-visit-data.js"></script>

  <script>
    const STATE_DATA = window.STATE_VISIT_DATA || {};
    const VALUE_FIELD = "visitation2024k"; // values are in thousands (000)
    const colorBreaks = [50, 100, 250, 500, 1000, 2000, 4000, 8000];
    const AVATAR_IMAGE_SRC = "avatar.png";
    const AVATAR_STORAGE_KEY = "state-avatar-history-v1";
    const AVATAR_SLOT_SPACING = 18;

    function cssVar(name) {
      const css = getComputedStyle(document.documentElement);
      return css.getPropertyValue(name).trim();
    }

    function getStateName(feature) {
      return feature?.properties?.name || feature?.id || "State";
    }

    function getStateMetric(feature) {
      return STATE_DATA[getStateName(feature)] || null;
    }

    function getFillColor(metric) {
      if (!metric || typeof metric[VALUE_FIELD] !== "number") return cssVar("--no-data");
      const v = metric[VALUE_FIELD];
      if (v > colorBreaks[7]) return "#6e1711";
      if (v > colorBreaks[6]) return "#9b2219";
      if (v > colorBreaks[5]) return "#c33a1f";
      if (v > colorBreaks[4]) return "#e05a2a";
      if (v > colorBreaks[3]) return "#ef8354";
      if (v > colorBreaks[2]) return "#f4a261";
      if (v > colorBreaks[1]) return "#f8bf85";
      if (v > colorBreaks[0]) return "#fbd7ac";
      return "#fee9cf";
    }

    function baseStyle(feature){
      const metric = getStateMetric(feature);
      return {
        color: cssVar("--stroke"),
        weight: 1,
        fillColor: getFillColor(metric),
        fillOpacity: 0.95
      };
    }

    function hoverStyle(){
      return {
        color: "#ffffff",
        weight: 2,
        fillColor: cssVar("--hover"),
        fillOpacity: 1
      };
    }

    function formatThousands(value) {
      return typeof value === "number" ? `${value.toLocaleString()}k` : "No data";
    }

    function formatPercent(value) {
      return typeof value === "number" ? `${(value * 100).toFixed(1)}%` : "No data";
    }

    function attachInteractions(feature, layer){
      const name = getStateName(feature);
      const metric = getStateMetric(feature);
      const tooltipHtml = `
        <div class="tooltip-title">${name}</div>
        <div>${metric ? `Rank: ${metric.rank}` : "Rank: No data"}</div>
        <div>2024 visitation: ${formatThousands(metric?.visitation2024k)}</div>
        <div>2023 visitation: ${formatThousands(metric?.visitation2023k)}</div>
        <div>YoY change: ${formatPercent(metric?.pctChange)}</div>
        <div>2024 market share: ${formatPercent(metric?.marketShare2024)}</div>
      `;

      layer.bindTooltip(tooltipHtml, {
        sticky: true,
        direction: "auto",
        className: "state-tooltip"
      });

      layer.on("mouseover", () => layer.setStyle(hoverStyle()));
      layer.on("mouseout", () => layer.setStyle(baseStyle(feature)));
    }

    function addLegend(map) {
      const legend = L.control({ position: "bottomleft" });
      legend.onAdd = function() {
        const div = L.DomUtil.create("div", "map-legend");
        const labels = [];
        let from = 0;

        for (const to of colorBreaks) {
          labels.push(
            `<div class="legend-row"><span class="swatch" style="background:${getFillColor({ [VALUE_FIELD]: to - 1 })}"></span>${from.toLocaleString()}-${to.toLocaleString()}k</div>`
          );
          from = to;
        }
        labels.push(
          `<div class="legend-row"><span class="swatch" style="background:${getFillColor({ [VALUE_FIELD]: colorBreaks[colorBreaks.length - 1] + 1 })}"></span>${colorBreaks[colorBreaks.length - 1].toLocaleString()}k+</div>`
        );
        labels.push(
          `<div class="legend-row"><span class="swatch" style="background:${cssVar("--no-data")}"></span>No data</div>`
        );

        div.innerHTML = `
          <div class="legend-title">2024 visitation (000)</div>
          ${labels.join("")}
          <div class="legend-note">Source: NTTO / SIAT (workbook provided)</div>
        `;
        return div;
      };
      legend.addTo(map);
    }

    function addSummaryPill(map, geojson) {
      const total = geojson.features.reduce((sum, f) => {
        const v = getStateMetric(f)?.[VALUE_FIELD];
        return sum + (typeof v === "number" ? v : 0);
      }, 0);
      const count = geojson.features.filter(f => typeof getStateMetric(f)?.[VALUE_FIELD] === "number").length;
      const pill = L.control({ position: "topright" });
      pill.onAdd = function() {
        const div = L.DomUtil.create("div", "map-pill");
        div.innerHTML = `<strong>${count}</strong> map regions with data â€¢ <strong>${total.toLocaleString()}k</strong> total visitors`;
        return div;
      };
      pill.addTo(map);
    }

    const stateCenters = {};
    const avatarMarkers = [];
    let avatarsVisible = true;

    function escapeHtml(value) {
      return String(value).replace(/[&<>"']/g, (ch) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#39;"
      }[ch]));
    }

    function getInitials(name) {
      const initials = String(name || "Traveler")
        .trim()
        .split(/\s+/)
        .filter(Boolean)
        .slice(0, 2)
        .map((part) => part[0].toUpperCase())
        .join("");
      return initials || "T";
    }

    function cacheStateCenters(layer, mapKey) {
      layer.eachLayer((stateLayer) => {
        const name = getStateName(stateLayer.feature);
        const bounds = stateLayer.getBounds?.();
        if (bounds && bounds.isValid()) {
          stateCenters[name] = { mapKey, center: bounds.getCenter() };
        }
      });
    }

    function addStateLabels(layer, map) {
      layer.eachLayer((stateLayer) => {
        const name = getStateName(stateLayer.feature);
        const bounds = stateLayer.getBounds?.();
        if (!bounds || !bounds.isValid()) return;
        const center = bounds.getCenter();
        L.marker(center, {
          interactive: false,
          keyboard: false,
          icon: L.divIcon({
            className: "state-name-label-wrap",
            html: `<span class="state-name-label">${escapeHtml(name)}</span>`
          })
        }).addTo(map);
      });
    }

    function getMapByKey(mapKey) {
      if (mapKey === "ak") return akMap;
      if (mapKey === "hi") return hiMap;
      return mainMap;
    }

    function saveAvatarsToStorage() {
      try {
        const payload = avatarMarkers.map((item) => ({
          personName: item.personName,
          stateName: item.stateName
        }));
        localStorage.setItem(AVATAR_STORAGE_KEY, JSON.stringify(payload));
      } catch (_) {}
    }

    function readAvatarsFromStorage() {
      try {
        const raw = localStorage.getItem(AVATAR_STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.filter((item) => item && item.personName && item.stateName);
      } catch (_) {
        return [];
      }
    }

    function getAvatarOffsetForState(stateName) {
      const idx = avatarMarkers.filter((item) => item.stateName === stateName).length;
      if (idx === 0) return 0;
      const step = Math.ceil(idx / 2);
      const dir = idx % 2 === 1 ? -1 : 1;
      return dir * step * AVATAR_SLOT_SPACING;
    }

    function updateAvatarButtons() {
      const toggleBtn = document.getElementById("avatar-toggle-btn");
      if (!toggleBtn) return;
      toggleBtn.textContent = avatarsVisible ? "Hide Avatars" : "Show Avatars";
    }

    function clearAllAvatars() {
      avatarMarkers.forEach((item) => {
        const map = getMapByKey(item.mapKey);
        if (map.hasLayer(item.marker)) {
          map.removeLayer(item.marker);
        }
      });
      avatarMarkers.length = 0;
      try {
        localStorage.removeItem(AVATAR_STORAGE_KEY);
      } catch (_) {}
    }

    function setAvatarVisibility(visible) {
      avatarsVisible = visible;
      avatarMarkers.forEach((item) => {
        const map = getMapByKey(item.mapKey);
        if (visible) {
          if (!map.hasLayer(item.marker)) {
            item.marker.addTo(map);
          }
        } else if (map.hasLayer(item.marker)) {
          map.removeLayer(item.marker);
        }
      });
      updateAvatarButtons();
    }

    function setupAvatarControls() {
      const toggleBtn = document.getElementById("avatar-toggle-btn");
      const clearBtn = document.getElementById("avatar-clear-btn");
      if (!toggleBtn || !clearBtn) return;

      toggleBtn.addEventListener("click", () => {
        setAvatarVisibility(!avatarsVisible);
      });

      clearBtn.addEventListener("click", () => {
        clearAllAvatars();
      });

      updateAvatarButtons();
    }

    function renderStateAvatar(personName, stateName, options = {}) {
      const target = stateCenters[stateName];
      if (!target) return false;

      const map = getMapByKey(target.mapKey);
      const safeName = escapeHtml(personName || "Traveler");
      const initials = getInitials(personName);
      const xOffset = getAvatarOffsetForState(stateName);

      const icon = L.divIcon({
        className: "state-avatar-wrap",
        html: `
          <div class="state-avatar-slot" style="transform: translateX(${xOffset}px);" aria-hidden="true">
            <div class="state-avatar-person">
              <img class="state-avatar-image" src="${AVATAR_IMAGE_SRC}" alt="Avatar" />
              <div class="person-label">${escapeHtml(initials)}</div>
            </div>
          </div>
        `,
        iconSize: [220, 86],
        iconAnchor: [110, 78]
      });

      const marker = L.marker(target.center, { icon, keyboard: false });
      if (avatarsVisible) {
        marker.addTo(map);
      }
      marker.bindTooltip(`${safeName} matched with ${escapeHtml(stateName)}`, {
        direction: "top",
        offset: [0, -14],
        className: "state-tooltip"
      });
      avatarMarkers.push({ marker, mapKey: target.mapKey, personName: safeName, stateName });
      if (options.persist !== false) {
        saveAvatarsToStorage();
      }
      return true;
    }

    function restoreAvatarsFromStorage() {
      const saved = readAvatarsFromStorage();
      saved.forEach((entry) => {
        renderStateAvatar(entry.personName, entry.stateName, { persist: false });
      });
    }

    window.renderStateAvatar = renderStateAvatar;
    window.clearAllAvatars = clearAllAvatars;
    window.setAvatarVisibility = setAvatarVisibility;

    // ---- Create 3 maps: main + 2 insets ----
    const mainMap = L.map("map", {
      zoomControl: false,
      attributionControl: false,
      preferCanvas: true,
      dragging: true,
      scrollWheelZoom: true
    });

    const akMap = L.map("map-ak", {
      zoomControl: false,
      attributionControl: false,
      preferCanvas: true,
      dragging: false,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false,
      keyboard: false,
      tap: false
    });

    const hiMap = L.map("map-hi", {
      zoomControl: false,
      attributionControl: false,
      preferCanvas: true,
      dragging: false,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false,
      keyboard: false,
      tap: false
    });

    // Optional: stop clicks on inset from panning main map (extra safe)
    L.DomEvent.disableClickPropagation(document.getElementById("map-ak"));
    L.DomEvent.disableClickPropagation(document.getElementById("map-hi"));
    setupAvatarControls();

    // ---- Load GeoJSON once, split into layers ----
    fetch("us-states.json") // <-- your file name
      .then(r => r.json())
      .then(data => {

        const isAK = f => (f?.properties?.name === "Alaska" || f?.id === "02");
        const isHI = f => (f?.properties?.name === "Hawaii" || f?.id === "15");
        // Lower 48 = everything except Alaska & Hawaii (keep DC if you want)
        const lower48 = {
          type: "FeatureCollection",
          features: data.features.filter(f => !isAK(f) && !isHI(f))
        };

        const alaska = {
          type: "FeatureCollection",
          features: data.features.filter(isAK)
        };

        const hawaii = {
          type: "FeatureCollection",
          features: data.features.filter(isHI)
        };

        // --- Main layer (lower 48) ---
        const lowerLayer = L.geoJSON(lower48, {
          style: baseStyle,
          onEachFeature: attachInteractions
        }).addTo(mainMap);
        cacheStateCenters(lowerLayer, "main");
        addStateLabels(lowerLayer, mainMap);

        mainMap.fitBounds(lowerLayer.getBounds(), { padding: [40, 40] });
        addLegend(mainMap);
        addSummaryPill(mainMap, data);

        // --- Alaska inset ---
        const akLayer = L.geoJSON(alaska, {
          style: baseStyle,
          onEachFeature: attachInteractions
        }).addTo(akMap);
        cacheStateCenters(akLayer, "ak");
        addStateLabels(akLayer, akMap);

        if (akLayer.getBounds().isValid()) {
          akMap.fitBounds(akLayer.getBounds(), { padding: [10, 10] });
        }

        // --- Hawaii inset ---
        const hiLayer = L.geoJSON(hawaii, {
          style: baseStyle,
          onEachFeature: attachInteractions
        }).addTo(hiMap);
        cacheStateCenters(hiLayer, "hi");
        addStateLabels(hiLayer, hiMap);

        if (hiLayer.getBounds().isValid()) {
          hiMap.fitBounds(hiLayer.getBounds(), { padding: [10, 10] });
        }

        // ---- "Zoom it in" a bit like D3's framing ----
        // After fitting, zoom in one level for a tighter look:
        mainMap.setZoom(mainMap.getZoom() + .5);
        restoreAvatarsFromStorage();

      })
      .catch(err => console.error("Failed to load us-states.json:", err));
  </script>
  <script src="state-recommender-game.js"></script>
  <script src="visualization-tabs.js"></script>
</body>
</html>
